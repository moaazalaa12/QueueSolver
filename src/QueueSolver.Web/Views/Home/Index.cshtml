

@{
    ViewData["Title"] = "Queue Theory Solver";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-3 bg-light p-4 rounded shadow-sm h-100">
            <h4 class="mb-3">Configuration</h4>
            <form id="simForm">
                <div class="mb-3">
                    <label class="form-label fw-bold">Arrival Pattern</label>
                    <select class="form-select" id="arrDist">
                        <option value="0">Markovian (Poisson)</option>
                        <option value="1">Deterministic</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Service Pattern</label>
                    <select class="form-select" id="svcDist">
                        <option value="0">Markovian (Exp)</option>
                        <option value="1">Deterministic</option>
                    </select>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label fw-bold">λ (Arrival)</label>
                        <input type="number" class="form-control" id="lambda" value="2" step="0.1">
                    </div>
                    <div class="col">
                        <label class="form-label fw-bold">µ (Service)</label>
                        <input type="number" class="form-control" id="mu" value="3" step="0.1">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label fw-bold">Servers (c)</label>
                        <input type="number" class="form-control" id="servers" value="1">
                    </div>
                    <div class="col">
                        <label class="form-label fw-bold">Capacity (K)</label>
                        <input type="number" class="form-control" id="capacity" value="50">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Customers (N)</label>
                    <input type="number" class="form-control" id="numCust" value="20">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Initial Customers (M)</label>
                    <input type="number" class="form-control" id="initialCust" value="0" min="0">
                </div>

                @* <div class="form-check mb-3 bg-white p-2 border rounded">
                    <input class="form-check-input ms-1" type="checkbox" id="forceSim">
                    <label class="form-check-label ms-2 fw-bold" title="يتجاهل القوانين النظرية ويقوم بمحاكاة الواقع عميل بعميل. مفيد لرؤية التذبذب العشوائي">
                        Force Simulation Mode ℹ️
                    </label>
                    <div class="text-muted small ms-4" style="font-size: 0.8em;">
                        (يجبر النظام على المحاكاة اليدوية بدلاً من المعادلات الجاهزة)
                    </div>
                </div> *@

                <button type="button" class="btn btn-primary w-100 py-2 fw-bold" onclick="startSimulation()">
                    Run Solver
                </button>
            </form>

            <hr class="my-4" />

            <h5 class="mb-3">Results Summary</h5>
            <div id="statsPanel" class="p-3 bg-white rounded border text-center">
                <h6 class="text-muted">System Full/Empty Sytem Time (ti)</h6>
                <h2 class="text-primary fw-bold" id="valTi">-</h2>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Timeline Visualization</h5>
                    <span class="badge bg-secondary" id="statusBadge">Idle</span>
                </div>
                <div class="card-body overflow-auto bg-white position-relative" id="vizContainer">
                </div>
            </div>

            <div class="card mb-3 bg-light border-0">
                <div class="card-body py-2 d-flex align-items-center">
                    <label class="fw-bold me-3">Time Scale Zoom:</label>
                    <input type="range" class="form-range w-50" id="chartZoom" min="10" max="100" value="100" oninput="updateChartScale(this.value)">
                    <span class="ms-2 text-muted small">(Drag to expand/shrink time axis)</span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Customers in System (Queue + Service)</h5>
                        </div>
                        <div class="card-body bg-white">
                            <canvas id="systemChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Customers in Queue Only</h5>
                        </div>
                        <div class="card-body bg-white">
                            <canvas id="queueChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Detailed Metrics per Customer</h5>
                </div>
                <div class="card-body bg-white p-0">
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-striped table-hover text-center align-middle mb-0" id="resultsTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>Arrival</th>
                                    <th>Start Service (ti)</th>
                                    <th>Wait (Wq)</th>
                                    <th>Duration</th>
                                    <th>Departure</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let systemChart, queueChart;
        let originalMaxTime = 10;

        // --- Setup Charts ---
        const commonOptions = {
            responsive: true,
            interaction: { intersect: false, axis: 'x' },
            elements: { point: { radius: 0 } }, // إخفاء النقاط لتسريع الرسم
            scales: {
                x: { type: 'linear', title: { display: true, text: 'Time (t)' } },
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            animation: false
        };

        const ctx1 = document.getElementById('systemChart').getContext('2d');
        systemChart = new Chart(ctx1, {
            type: 'line',
            data: { datasets: [{ label: 'In System', data: [], borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.2)', stepped: true, fill: true }] },
            options: { ...commonOptions, plugins: { title: { display: true, text: 'L(t)' } } }
        });

        const ctx2 = document.getElementById('queueChart').getContext('2d');
        queueChart = new Chart(ctx2, {
            type: 'line',
            data: { datasets: [{ label: 'In Queue', data: [], borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.2)', stepped: true, fill: true }] },
            options: { ...commonOptions, plugins: { title: { display: true, text: 'Nq(t)' } } }
        });

        // --- Update Scale Function ---
        function updateChartScale(val) {
            // val is percentage (10 to 100)
            const newMax = originalMaxTime * (100 / val);

            if(systemChart) {
                systemChart.options.scales.x.max = newMax;
                systemChart.update();
            }
            if(queueChart) {
                queueChart.options.scales.x.max = newMax;
                queueChart.update();
            }
        }

        // --- D3 Setup ---
        const margin = {top: 30, right: 30, bottom: 40, left: 40};
        const width = 1000 - margin.left - margin.right;
        const height = 350 - margin.top - margin.bottom;

        const svg = d3.select("#vizContainer").append("svg")
            .attr("width", "100%")
            .attr("viewBox", `0 0 1000 420`)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Gridlines Helper
        function make_x_gridlines(x) { return d3.axisBottom(x).ticks(10); }
        function make_y_gridlines(y) { return d3.axisLeft(y).ticks(5); }

        // --- Run Simulation ---
        async function startSimulation() {
            const btn = document.querySelector("button[onclick='startSimulation()']");
            btn.disabled = true;
            document.getElementById("statusBadge").innerText = "Running...";
            document.getElementById("statusBadge").className = "badge bg-warning text-dark";

            const payload = {
                arrivalDist: parseInt(document.getElementById("arrDist").value),
                serviceDist: parseInt(document.getElementById("svcDist").value),
                servers: parseInt(document.getElementById("servers").value),
                capacity: parseInt(document.getElementById("capacity").value),
                lambda: parseFloat(document.getElementById("lambda").value),
                mu: parseFloat(document.getElementById("mu").value),
                n: parseInt(document.getElementById("numCust").value),
                forceSimulation: document.getElementById("forceSim").checked,
                discipline: 0,
                initialCustomers: parseInt(document.getElementById("initialCust").value)
            };

            try {
                const response = await fetch('/api/simulation/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                renderResults(data);

                document.getElementById("statusBadge").innerText = "Completed";
                document.getElementById("statusBadge").className = "badge bg-success";
            } catch (e) {
                alert("Error: " + e);
                document.getElementById("statusBadge").innerText = "Error";
            } finally {
                btn.disabled = false;
            }
        }

        function renderResults(data) {
            document.getElementById("modeIndicator").innerText = (data.isAnalytical || data.IsAnalytical) ? "Analytical" : "Simulation";

            // 1. Ti Metric
            const ti = data.firstBusyTime ?? data.FirstBusyTime;
            document.getElementById("valTi").innerText = ti !== null ? ti.toFixed(2) : "Never Full";

            // 2. Charts Data Prep
            const customers = data.results || data.Results || [];
            const sysHist = (data.systemSizeHistory || data.SystemSizeHistory || []).map(h => ({ x: h.time ?? h.Time, y: h.count ?? h.Count }));
            const qHist = (data.queueSizeHistory || data.QueueSizeHistory || []).map(h => ({ x: h.time ?? h.Time, y: h.count ?? h.Count }));

            originalMaxTime = d3.max(customers, d => (d.completionTime ?? d.CompletionTime)) * 1.05 || 10;

            // Update Charts
            systemChart.data.datasets[0].data = sysHist;
            queueChart.data.datasets[0].data = qHist;

            // Add final point to close the step chart
            if(sysHist.length > 0) systemChart.data.datasets[0].data.push({x: originalMaxTime, y: sysHist[sysHist.length-1].y});
            if(qHist.length > 0) queueChart.data.datasets[0].data.push({x: originalMaxTime, y: qHist[qHist.length-1].y});

            // Reset Zoom
            document.getElementById("chartZoom").value = 100;
            updateChartScale(100);

            // 3. D3 Visualization (With Grid)
            svg.selectAll("*").remove(); // Clear all

            // Scales
            const x = d3.scaleLinear().domain([0, originalMaxTime]).range([0, width]);
            const y = d3.scaleLinear().domain([0, 3]).range([height, 0]); // Dummy Y for grid logic

            // Add Gridlines (الطلب بتاعك: محاور ونقط)
            svg.append("g").attr("class", "grid").attr("transform", `translate(0, ${height})`)
                .style("stroke-dasharray", ("3,3")).style("opacity", 0.2)
                .call(make_x_gridlines(x).tickSize(-height).tickFormat(""));

            // Row Labels
            svg.append("text").attr("x", -35).attr("y", 50).text("Arr").style("font-weight", "bold");
            svg.append("text").attr("x", -35).attr("y", 150).text("Svc").style("font-weight", "bold");
            svg.append("text").attr("x", -35).attr("y", 250).text("Dep").style("font-weight", "bold");

            // Axis
            svg.append("g").attr("transform", `translate(0, ${height})`).call(d3.axisBottom(x));

            const g = svg.append("g").attr("class", "event-group");

            customers.forEach((c, i) => {
                const id = c.id ?? c.Id;
                const arrT = c.arrivalTime ?? c.ArrivalTime;
                const svcT = c.serviceStartTime ?? c.ServiceStartTime;
                const depT = c.completionTime ?? c.CompletionTime;
                const color = d3.schemeCategory10[i % 10];
                const arrX = x(arrT);

                // Arrival Line
                g.append("line").attr("x1", arrX).attr("y1", 30).attr("x2", arrX).attr("y2", 70)
                 .attr("stroke", color).attr("stroke-width", 2);
                g.append("text").attr("x", arrX).attr("y", 25).text(`C${id}`).attr("font-size", "10px").attr("text-anchor", "middle");
                g.append("text").attr("x", arrX).attr("y", 82).text(arrT.toFixed(1)).attr("font-size", "9px").attr("fill", "#555").attr("text-anchor", "middle");

                if (c.isRejected ?? c.IsRejected) {
                     g.append("text").attr("x", arrX).attr("y", 95).text("X").attr("fill", "red").attr("font-weight", "bold");
                }
                else if (svcT != null) {
                    const svcX = x(svcT);
                    const depX = x(depT);

                    // Connector (Wait)
                    if (svcX > arrX) {
                         g.append("line").attr("x1", arrX).attr("y1", 70).attr("x2", svcX).attr("y2", 130)
                          .attr("stroke", "#ccc").attr("stroke-dasharray", "4");
                         // Small dot at service start
                         g.append("circle").attr("cx", svcX).attr("cy", 130).attr("r", 3).attr("fill", color);
                    }

                    // Service Line
                    g.append("line").attr("x1", svcX).attr("y1", 130).attr("x2", svcX).attr("y2", 170)
                     .attr("stroke", color).attr("stroke-width", 2);
                    g.append("text").attr("x", svcX).attr("y", 125).text(svcT.toFixed(1))
                     .attr("font-size", "10px").attr("font-weight", "bold").attr("text-anchor", "middle");

                    // Connector (Service Duration Flow)
                    g.append("line").attr("x1", svcX).attr("y1", 170).attr("x2", depX).attr("y2", 230)
                     .attr("stroke", color).attr("stroke-width", 1);

                    // Departure Line
                    g.append("line").attr("x1", depX).attr("y1", 230).attr("x2", depX).attr("y2", 270)
                     .attr("stroke", color).attr("stroke-width", 2);
                    g.append("text").attr("x", depX).attr("y", 285).text(depT.toFixed(1))
                     .attr("font-size", "9px").attr("fill", "#555").attr("text-anchor", "middle");
                }
            });

            // 4. Fill Table
            const tableBody = document.querySelector("#resultsTable tbody");
            tableBody.innerHTML = "";
            customers.forEach(c => {
                const id = c.id ?? c.Id;
                const arrT = c.arrivalTime ?? c.ArrivalTime;
                const svcT = c.serviceStartTime ?? c.ServiceStartTime;
                const depT = c.completionTime ?? c.CompletionTime;
                const dur = c.serviceDuration ?? c.ServiceDuration;
                const wq = c.waitingTime ?? c.WaitingTime ?? 0;

                let statusBadge = wq > 0.001 ? '<span class="badge bg-warning text-dark">Wait</span>' : '<span class="badge bg-success">Direct</span>';
                if(c.isRejected ?? c.IsRejected) statusBadge = '<span class="badge bg-danger">Rejected</span>';

                const row = `
                    <tr>
                        <td>${id}</td>
                        <td>${arrT.toFixed(2)}</td>
                        <td class="fw-bold text-primary">${svcT?.toFixed(2) ?? '-'}</td>
                        <td class="fw-bold">${wq.toFixed(2)}</td>
                        <td>${dur.toFixed(2)}</td>
                        <td>${depT?.toFixed(2) ?? '-'}</td>
                        <td>${statusBadge}</td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
        }
    </script>
}